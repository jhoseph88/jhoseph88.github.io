<!DOCTYPE html>
<html>
<head>
  <title>Google Maps with User Location and Radius</title>
  <style>
    #map { height: 100vh; width: 100vh; float: left; }
    #list { height: 100vh; width: 30%; float: left; overflow-y: auto; padding: 10px; box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="list"></div>
  <script>
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        apiKey: params.get('apiKey'),
        maxDistance: params.get('maxDistance') || 5 // Default to 5 miles
      };
    }

    const { apiKey, maxDistance } = getQueryParams();

    function loadScript(src, callback) {
      const script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.defer = true;
      script.onload = callback;
      document.head.appendChild(script);
    }

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };

          const map = new google.maps.Map(document.getElementById('map'), {
            center: userLocation,
            zoom: 12
          });

          new google.maps.Marker({
            position: userLocation,
            map: map,
            title: 'You are here'
          });

          map.addListener('idle', () => updateList(map, userLocation));
          updateList(map, userLocation);
        }, () => {
          console.log('Error: The Geolocation service failed.');
        });
      } else {
        console.log('Error: Your browser doesn\'t support geolocation.');
      }
    }

    async function updateList(map, userLocation) {
      const bounds = map.getBounds();
      const list = document.getElementById('list');
      list.innerHTML = '';

      const response = await fetch(`/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${maxDistance}&type=restaurant`);
      const data = await response.json();

      data.results.forEach(place => {
        const item = document.createElement('div');
        item.textContent = place.name;
        list.appendChild(item);

        new google.maps.Marker({
          position: place.geometry.location,
          map: map,
          title: place.name
        });
      });
    }

    window.onload = () => {
      if (apiKey) {
        loadScript(`https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`, initMap);
      } else {
        console.error('API key not provided in query parameters.');
      }
    };
  </script>
</body>
</html>
